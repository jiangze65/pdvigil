<!-- templates/chart.html -->
{% extends "base.html" %}
{% block content %}
<!--
		var data = {
			"pdchart_label":[], 
			"pdchart_data":[],
			"pdchart_plotx":[],
			"pdchart_ploty":[],
			"wvchart_label":[], 
			"wvart_data":[], 
			"fftchart_label":[], 
			"fftchart_data":[], 
			"points": 31
			};
-->

<div class="tile is-ancestor">
		<div class="tile">
		  <div class="chart-container">
			<canvas id="pdchart"></canvas>
		  </div>
		</div>
		<div class="tile">
		  <div class="chart-container">
			<canvas id="wvchart"></canvas>
		  </div>
	</div>
</div>
<div class="tile is-ancestor">
		<div class="tile">
		  <div class="chart-container">
			<form action="{{ url_for('main.chart')}}" method="post">
				Selected Index: <input type="text" name="pointSelected" id="pointSelected"><br>
				<input type="submit" value="Submit">
			</form>
			<table id="points-on-index" class="table is-striped is-fullwidth" width: 100%>
				<tr class="th">
					<th>ID</th>
					<th>Time</th>
					<th>Phase</th>
					<th>Peak</th>
				</tr>
				<tr>
					<td>123</td>
					<td>2020 Sept 10, 10:30:31am</td>
					<td>1125</td>
					<td>345</td>
				</tr>
				<tr>
					<td>123</td>
					<td>2020 Sept 10, 10:30:31am</td>
					<td>1125</td>
					<td>345</td>
				</tr>
				<tr>
					<td>123</td>
					<td>2020 Sept 10, 10:30:31am</td>
					<td>1125</td>
					<td>345</td>
				</tr>
				<tr>
					<td>123</td>
					<td>2020 Sept 10, 10:30:31am</td>
					<td>1125</td>
					<td>345</td>
				</tr>
				<tr>
					<td>123</td>
					<td>2020 Sept 10, 10:30:31am</td>
					<td>1125</td>
					<td>345</td>
				</tr>
			</table>
		  </div>
		</div>
		<div class="tile">
		  <div class="chart-container">
			<canvas id="chart4"></canvas>
		  </div>
		</div>
</div>
    <script>
	  var org ='{{ data | tojson | safe}}';
	  org = org.replace(/\\/g, '');
	  org = org.slice(1,-1); 
	  var data = JSON.parse(org);
	  
      // Global parameters:
      // resize the chart canvas when its container does
      Chart.defaults.global.responsive = true;
	  	function twoDArray(x, y){
			var twoDArray =[];
			for(let i = 0; i < x.length; i++){ 
				twoDArray.push({x:+x[i],y:y[i]});
			}
			return twoDArray;
		}
		var twoDArray = twoDArray(data.pdchart_plotx,data.pdchart_ploty);
		//console.log(twoDArray); 
      // define the chart data
      var chartData = {
        labels : data.pdchart_label,  
        datasets : [{
            label: 'Phase',
            fill: true,
            showLine: true,
			data: data.pdchart_data,
            spanGaps: false
			},
			{
			type: 'bubble',
			label: 'PD Chart',
			data: twoDArray,
			backgroundColor: "rgba(76,78,80, .7)",
			borderColor: "transparent"
			}
			]
      }

      // get chart canvas
      var holder = document.getElementById("pdchart");
      var ctx = document.getElementById("pdchart").getContext("2d");
      // create the chart using the chart canvas
      var pdchart = new Chart(ctx, {
			type: 'line',
			data: chartData,
        options: {	
          tooltips: {
            enabled: true,
            mode: 'single',
            callbacks: {
              label: function(tooltipItems, data) {
                       return tooltipItems.yLabel;
                     }
            }
          },
        }
      });
	  console.log(data.wvchart_data);
      // define the wvchart data
      var chartData2 = {
        labels : data.wvchart_label,	  
        datasets : [{
            label: 'WaveForm',
            fill: true,
            data : data.wvchart_data,
            spanGaps: false
        }]
      }
      // get wvchart canvas
      var holder2 = document.getElementById("wvchart");
      var ctx2 = document.getElementById("wvchart").getContext("2d");
      // create the chart using the chart canvas
      var wvchart = new Chart(ctx2, {
        type: 'line',
        data: chartData2,
        options: {
          tooltips: {
            enabled: true,
            mode: 'single',
            callbacks: {
              label: function(tooltipItems, data) {
                       return tooltipItems.yLabel;
                     }
            }
          },
        }
      });

      // define the chart4 data
      var chartData4 = {
        labels : data.fftchart_label,	  
        datasets : [{
            label: 'FFT Chart',
            fill: true,
            data : data.fftchart_data,
            spanGaps: false
        }]
      }
      // get chart4 canvas
      var holder4 = document.getElementById("chart4");
      var ctx4 = document.getElementById("chart4").getContext("2d");
      // create the chart using the chart canvas
      var chart4 = new Chart(ctx4, {
        type: 'line',
        data: chartData4,
        options: {
          tooltips: {
            enabled: true,
            mode: 'single',
            callbacks: {
              label: function(tooltipItems, data) {
					   document.getElementById("pointSelected").value = tooltipItems.yLabel;
                       return tooltipItems.yLabel;
                     }
            }
          },
        }
      });
	  
      // create a callback function for updating the selected index on the chart
      holder.onclick = function(evt){
		var activePoints = pdchart.getElementsAtEventForMode(evt, 'point', pdchart.options);
        var firstPoint = activePoints[0];
        var label = pdchart.data.labels[firstPoint._index];
        var value = pdchart.data.datasets[firstPoint._datasetIndex].data[firstPoint._index];
        console.log(label+";" + value.y);
		document.getElementById("pointSelected").value = label;
      };
    </script>
{% endblock %}
